services:
  web:
    build: .
    ports:
      - "8080:80"
    volumes:
      - .:/var/www/html
    environment:
      - DB_HOST=db
      - DB_NAME=browsergame
      - DB_USER=browsergame
      - DB_PASSWORD=sicheresPasswort
    depends_on:
      - db
    networks:
      - browsergame-network

  db:
    image: mariadb:10.9
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: browsergame
      MYSQL_USER: browsergame
      MYSQL_PASSWORD: sicheresPasswort
    ports:
      - "3306:3306"
    volumes:
      # Phase 1: Database setup
      - ./sql/01-database-setup.sql:/docker-entrypoint-initdb.d/01-database-setup.sql
      # Phase 2: Table creation (in dependency order)
      - ./sql/tables/core_tables.sql:/docker-entrypoint-initdb.d/02-core-tables.sql
      - ./sql/tables/military_tables.sql:/docker-entrypoint-initdb.d/03-military-tables.sql
      - ./sql/tables/research_tables.sql:/docker-entrypoint-initdb.d/04-research-tables.sql
      - ./sql/tables/kaserne_tables.sql:/docker-entrypoint-initdb.d/05-kaserne-tables.sql
      - ./sql/tables/travel_tables.sql:/docker-entrypoint-initdb.d/06-travel-tables.sql
      - ./sql/tables/battle_tables.sql:/docker-entrypoint-initdb.d/07-battle-tables.sql
      # Phase 3: Configuration data (in dependency order)
      - ./sql/data/initial_data.sql:/docker-entrypoint-initdb.d/10-initial-data.sql
      - ./sql/data/military_data.sql:/docker-entrypoint-initdb.d/11-military-data.sql
      - ./sql/data/research_data.sql:/docker-entrypoint-initdb.d/12-research-data.sql
      - ./sql/data/kaserne_data.sql:/docker-entrypoint-initdb.d/13-kaserne-data.sql
      - ./sql/data/military_travel_data.sql:/docker-entrypoint-initdb.d/14-military-travel-data.sql
      # Phase 4: Stored procedures (in dependency order)
      - ./sql/procedures/player_procedures.sql:/docker-entrypoint-initdb.d/20-player-procedures.sql
      - ./sql/procedures/building_procedures.sql:/docker-entrypoint-initdb.d/21-building-procedures.sql
      - ./sql/procedures/military_procedures.sql:/docker-entrypoint-initdb.d/22-military-procedures.sql
      - ./sql/procedures/travel_procedures.sql:/docker-entrypoint-initdb.d/23-travel-procedures.sql
      - ./sql/procedures/initialization_procedures.sql:/docker-entrypoint-initdb.d/24-initialization-procedures.sql
      # Phase 5: Views (depend on tables and procedures)
      - ./sql/views/game_views.sql:/docker-entrypoint-initdb.d/30-game-views.sql
      - ./sql/views/enhanced_views.sql:/docker-entrypoint-initdb.d/31-enhanced-views.sql
      # Phase 6: Events and automation
      - ./sql/data/database_events.sql:/docker-entrypoint-initdb.d/40-database-events.sql
      # Phase 7: Final setup and validation
      - ./sql/99-final-setup.sql:/docker-entrypoint-initdb.d/99-final-setup.sql
      # Configuration
      - ./docker/mariadb.cnf:/etc/mysql/conf.d/browsergame.cnf
      - db_data:/var/lib/mysql
    networks:
      - browsergame-network

volumes:
  db_data:

networks:
  browsergame-network:
    driver: bridge